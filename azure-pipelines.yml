# pillow-accel Azure Pipelines build

name: $(Date:yyyyMMdd).$(Rev:.r)

jobs:
  - job: Linux
    displayName: Linux build job. Builds all variants with conda build.
    pool:
      vmImage: 'Ubuntu 16.04'
    steps:
      - bash: |
          echo "##vso[task.prependpath]$CONDA/bin"
          echo "##vso[task.uploadfile]~/.bashrc"
          # Fix setup that causes warnings with conda and may not work
          sed -i '/^export PATH=.*miniconda/d' ~/.bashrc
          echo '. /usr/share/miniconda/etc/profile.d/conda.sh' >> ~/.bashrc
          echo "##vso[task.uploadfile]~/.bashrc"
        displayName: Initialise task. Setup conda.
      - bash: |
          conda create --yes --quiet --name buildEnv
          conda activate buildEnv
          conda install --yes --quiet --name buildEnv conda-build conda-verify
          # Store conda build path to variable to retrieve artifacts
          echo "##vso[task.setvariable variable=conda_build_prefix]$CONDA_PREFIX/conda-bld"
        displayName: Create conda environment
      - bash: |
          conda build . 2>&1 | tee ~/meta_build.log
          echo "##vso[task.uploadfile]~/meta_build.log"
        workingDirectory: $(Build.SourcesDirectory)/recipes/_pillow-accel-default/
        displayName: Build defaults metapackage
      - bash: |
          conda activate buildEnv
          conda build -c defaults -c conda-forge . 2>&1 | tee ~/pkg_build.log
          echo "##vso[task.uploadfile]~/pkg_build.log"
        workingDirectory: $(Build.SourcesDirectory)/recipes/pillow-accel/
        displayName: Build packages
      - task: PublishPipelineArtifact@0
        inputs:
          artifactName: 'linux64-packages'
          targetPath: '$(conda_build_prefix)/linux-64/*pillow-accel*.tar.bz2'
