# pillow-accel Azure Pipelines build

name: $(Date:yyyyMMdd).$(Rev:.r)

jobs:
  - job: Linux
    displayName: Linux build job. Builds all variants with conda build.
    pool:
      vmImage: 'Ubuntu 16.04'
    steps:
      - bash: echo "##vso[task.prependpath]$CONDA/bin"
        displayName: Setup conda path.
      - bash: |
          conda create --yes --quiet --name buildEnv conda-build conda-verify
          source activate buildEnv
          mkdir -p $(Build.ArtifactStagingDirectory)/linux-64/
        displayName: Setup job
      - bash: |
          source activate buildEnv
          conda build . --output-folder "$(Build.ArtifactStagingDirectory)"
        workingDirectory: $(Build.SourcesDirectory)/recipes/_pillow-accel-default/
        displayName: Build defaults metapackage
      - bash: |
          source activate buildEnv
          conda build -c defaults -c conda-forge .
          cp "$CONDA_PREFIX/conda-bld/**"" "$(Build.ArtifactStagingDirectory)"
        workingDirectory: $(Build.SourcesDirectory)/recipes/pillow-accel/
        displayName: Build packages
      - task: PublishPipelineArtifact@0
        inputs:
          artifactName: 'linux64-packages'
          targetPath: '$(Build.ArtifactStagingDirectory)/linux-64/*.tar.bz2'
